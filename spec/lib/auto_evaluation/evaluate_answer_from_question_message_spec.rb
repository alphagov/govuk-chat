RSpec.describe AutoEvaluation::EvaluateAnswerFromQuestionMessage, :aws_credentials_stubbed do
  let(:answer) { build(:answer) }
  let(:question_message) { "What is the capital of France?" }
  let(:score_result) { build(:auto_evaluation_score_result) }
  let(:evaluation_klass) { Class.new }

  before do
    allow(AnswerComposition::PipelineRunner)
      .to receive(:call)
      .with(
        question: an_instance_of(Question),
        pipeline: [
          AnswerComposition::Pipeline::SearchResultFetcher,
          AnswerComposition::Pipeline::Claude::StructuredAnswerComposer,
        ],
      )
      .and_return(answer)

    allow(evaluation_klass)
      .to receive(:call)
      .and_return(score_result)
  end

  it "calls the evaluation class with the correct parameters" do
    described_class.call(
      evaluation_class: evaluation_klass,
      question_message:,
    )

    expect(evaluation_klass).to have_received(:call).with(
      question_message:,
      answer_message: answer.message,
    )
  end

  it "returns the AutoEvaluation::ScoreResult generated by the evaluation class" do
    result = described_class.call(
      evaluation_class: evaluation_klass,
      question_message:,
    )
    expect(result).to eq(score_result)
  end

  context "when the generated answer has an error status" do
    let(:answer) { build(:answer, status: :error_answer_service_error, error_message: "Contrived error.") }

    it "raises a TaskFailedError with the correct message" do
      expected_error_message = "Answer has an error status: error_answer_service_error and error message: Contrived error."
      expect {
        described_class.call(
          evaluation_class: AutoEvaluation::Coherence,
          question_message:,
        )
      }.to raise_error(described_class::TaskFailedError, expected_error_message)
    end
  end
end
