<%
  input_id ||= "#{name.parameterize}-#{SecureRandom.hex(4)}"
  value ||= nil

  maxlength = Form::CreateQuestion::USER_QUESTION_LENGTH_MAXIMUM
  presence_error_message = Form::CreateQuestion::USER_QUESTION_PRESENCE_ERROR_MESSAGE
  length_error_message = Form::CreateQuestion::USER_QUESTION_LENGTH_ERROR_MESSAGE

  hint = "Please limit your question to #{maxlength} characters."
  hint_id = "#{input_id}-hint"

  error_items ||= []
  has_error ||= error_items.any?
  error_id = "#{input_id}-error"

  aria_described_by = []
  aria_described_by << hint_id
  aria_described_by << error_id
  aria_described_by = aria_described_by.join(" ")

  data_attributes = {
    module: "conversation-form",
    maxlength: maxlength,
    "presence-error-message": presence_error_message,
    "length-error-message": sprintf(length_error_message, count: maxlength),
  }

  form_group_classes = " app-c-conversation-form__form-group js-conversation-form-group"
  form_group_classes << " app-c-conversation-form__form-group--error" if error_items.any?

  input_classes = "app-c-conversation-form__input js-conversation-form-input"
  input_classes << " app-c-conversation-form__input--error" if error_items.any?
%>

<%= form_with url: url, class: "app-c-conversation-form js-conversation-form", data: data_attributes do |f| %>
  <%= content_tag :div, class: form_group_classes do %>
    <%= tag.ul(
      id: error_id,
      class: %w[govuk-list govuk-error-message js-conversation-form-errors-wrapper],
      hidden: !has_error,
      aria: { atomic: "true", live: "polite" }) do %>
      <% error_items.each do |error| %>
        <li>
          <span class="govuk-visually-hidden">Error:</span>
          <%= error[:text] %>
        </li>
      <% end %>
    <% end %>

    <%= content_tag :div, class: "app-c-conversation-form__input-wrapper" do %>
      <%= label_tag(
        input_id,
        "Enter your question (please do not share personal or sensitive information in your conversations with GOV UK chat)",
        class: "app-c-conversation-form__label govuk-visually-hidden",
      ) %>

      <%= text_field_tag(
        input_id,
        value,
        class: input_classes,
        aria: {
          describedby: aria_described_by,
        },
        name: name,
      ) %>

      <%= render "components/blue_button", {
        text: "Send",
        conversation_form_button: true,
      } %>
    <% end %>
  <% end %>

  <div class="govuk-visually-hidden">
    <%= render "govuk_publishing_components/components/hint", {
      id: hint_id,
      text: hint,
    } %>
  </div>
<% end %>

<%= link_to(
  "Share your feedback (opens in a new tab)",
  "https://surveys.publishing.service.gov.uk/s/0K1VSX/",
  class: "govuk-body govuk-link govuk-!-margin-bottom-3",
  target: "_blank",
  rel: "noopener noreferrer",
) %>
